<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ハノイの塔 (JavaScript)</title>
    <style>
        body {
            background-color: #f0f0f0;
            display: flex;
            /* ★★★ UIとCanvasを縦に並べる ★★★ */
            flex-direction: column; 
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Yu Gothic', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
        }
        /* ★★★ 選択ボタン用のUIスタイル ★★★ */
        #controls {
            margin-bottom: 15px;
        }
        #controls label {
            font-size: 18px;
            margin-right: 10px;
            vertical-align: middle;
        }
        #controls button {
            padding: 5px 15px;
            font-size: 16px;
            cursor: pointer;
            margin-left: 5px;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 4px;
        }
        #controls button:hover {
            background-color: #f5f5f5;
        }

        canvas {
            background-color: #FAF8EF; /* COLOR_BACKGROUND */
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>

<div id="controls">
    <label>円盤の枚数:</label>
    <button id="btn3">3枚</button>
    <button id="btn5">5枚</button>
    <button id="btn10">10枚</button>
</div>

<canvas id="gameCanvas" width="800" height="500"></canvas>

<script>
    // --- 定数 ---
    const SCREEN_WIDTH = 800;
    const SCREEN_HEIGHT = 500;

    // ★★★ 色の定義 (10色に増やす) ★★★
    const COLOR_PEG = "#8B4513";
    const COLOR_DISK_OUTLINE = "#000000";
    const COLOR_TEXT = "#000000";
    const COLOR_HIGHLIGHT = "#FFC107";
    const COLOR_WIN_BG = "rgba(245, 245, 245, 0.8)";

    // ★★★ 円盤の色 (10色) ★★★
    const DISK_COLORS = [
        "#D00000",   // 1
        "#FFA500",   // 2
        "#FFD700",   // 3
        "#008000",   // 4
        "#0047AB",   // 5
        "#8A2BE2",   // 6
        "#FFB6C1",   // 7
        "#FF1493",   // 8 (DeepPink)
        "#4B0082",   // 9 (Indigo)
        "#A9A9A9"    // 10 (DarkGray)
    ];

    // 円盤の見た目
    const DISK_HEIGHT = 30;
    const MIN_DISK_WIDTH = 60;
    const DISK_WIDTH_STEP = 30;

    // 杭の見た目
    const PEG_WIDTH = 15;
    const PEG_HEIGHT = 300;
    const PEG_Y_BOTTOM = 380; 
    const PEG_X_CENTERS = [SCREEN_WIDTH / 4, SCREEN_WIDTH / 2, SCREEN_WIDTH * 3 / 4];
    const BASE_HEIGHT = 20;

    class HanoiGame {
        constructor(canvasId, initialDisks) {
            this.canvas = document.getElementById(canvasId);
            this.ctx = this.canvas.getContext('2d');
            
            this.numDisks = initialDisks; // 初期枚数
            this.optimalMoves = (2 ** this.numDisks) - 1;

            // フォント設定
            this.fontLarge = "50px 'Yu Gothic', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif";
            this.fontMedium = "24px 'Yu Gothic', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif";
            
            this.setup();
            this.initEvents();
            this.run();
        }

        // ★★★ 円盤の枚数を変更してリセットするメソッド ★★★
        changeDisks(newNumDisks) {
            if (newNumDisks > DISK_COLORS.length) {
                alert(`色の定義が足りません。最大 ${DISK_COLORS.length} 枚までです。`);
                return;
            }
            this.numDisks = newNumDisks;
            this.optimalMoves = (2 ** newNumDisks) - 1;
            this.setup(); // setupを呼ぶだけでリセットされる
        }

        setup() {
            this.pegs = [[], [], []];
            
            // this.numDisks を参照して円盤をセット
            this.pegs[0] = Array.from({ length: this.numDisks }, (_, i) => this.numDisks - i);
            
            this.selectedPeg = null;
            this.moveCount = 0;
            this.isWin = false;
            this.startTime = performance.now();
            this.totalTime = 0;
        }

        initEvents() {
            this.canvas.addEventListener('click', (event) => {
                const rect = this.canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                this.handleClick(x);
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'r' || event.key === 'R') {
                    // Rキーは現在の枚数でリセット
                    this.setup();
                }
            });
        }

        getPegAtX(x) {
            const maxWidth = MIN_DISK_WIDTH + (this.numDisks - 1) * DISK_WIDTH_STEP;
            const clickMargin = maxWidth / 2;

            for (let i = 0; i < PEG_X_CENTERS.length; i++) {
                if (Math.abs(x - PEG_X_CENTERS[i]) < clickMargin) {
                    return i;
                }
            }
            return -1;
        }

        handleClick(x) {
            if (this.isWin) {
                this.setup();
                return;
            }

            const clickedPegIdx = this.getPegAtX(x);

            if (clickedPegIdx === -1) {
                this.selectedPeg = null;
                return;
            }

            if (this.selectedPeg === null) {
                if (this.pegs[clickedPegIdx].length > 0) {
                    this.selectedPeg = clickedPegIdx;
                }
            } else {
                this.moveDisk(this.selectedPeg, clickedPegIdx);
                this.selectedPeg = null; 
            }
        }

        moveDisk(fromIdx, toIdx) {
            if (fromIdx === toIdx) return;

            const fromStack = this.pegs[fromIdx];
            const toStack = this.pegs[toIdx];

            if (fromStack.length === 0) return; 

            const diskToMove = fromStack[fromStack.length - 1]; 

            if (toStack.length === 0 || diskToMove < toStack[toStack.length - 1]) {
                const disk = fromStack.pop();
                toStack.push(disk);
                this.moveCount++;
                this.checkWin();
            }
        }

        checkWin() {
            if (this.pegs[1].length === this.numDisks || this.pegs[2].length === this.numDisks) {
                this.isWin = true;
                this.totalTime = (performance.now() - this.startTime) / 1000;
            }
        }

        run() {
            this.draw();
            requestAnimationFrame(() => this.run());
        }

        drawText(text, x, y, font, color, align = "center") {
            this.ctx.fillStyle = color;
            this.ctx.font = font;
            this.ctx.textAlign = align;
            this.ctx.textBaseline = "middle";
            this.ctx.fillText(text, x, y);
        }

        draw() {
            this.ctx.clearRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);

            // --- 杭の描画 ---
            this.ctx.fillStyle = COLOR_PEG;
            PEG_X_CENTERS.forEach(x_center => {
                const baseWidth = SCREEN_WIDTH / 3.5;
                const baseLeft = x_center - baseWidth / 2;
                const baseTop = PEG_Y_BOTTOM - BASE_HEIGHT;
                this.ctx.fillRect(baseLeft, baseTop, baseWidth, BASE_HEIGHT);
                
                const pegLeft = x_center - PEG_WIDTH / 2;
                const pegTop = PEG_Y_BOTTOM - BASE_HEIGHT - PEG_HEIGHT;
                this.ctx.fillRect(pegLeft, pegTop, PEG_WIDTH, PEG_HEIGHT);
            });

            // --- 選択中ハイライトの描画 ---
            if (this.selectedPeg !== null) {
                const x_center = PEG_X_CENTERS[this.selectedPeg];
                const hlWidth = PEG_WIDTH + 15;
                const hlHeight = PEG_HEIGHT + 15;
                const hlLeft = x_center - hlWidth / 2;
                const hlTop = PEG_Y_BOTTOM - BASE_HEIGHT - PEG_HEIGHT - (hlHeight - PEG_HEIGHT) / 2;
                
                this.ctx.strokeStyle = COLOR_HIGHLIGHT;
                this.ctx.lineWidth = 5;
                this.ctx.strokeRect(hlLeft, hlTop, hlWidth, hlHeight);
            }

            // --- 円盤の描画 ---
            this.pegs.forEach((stack, pegIdx) => {
                const peg_x_center = PEG_X_CENTERS[pegIdx];
                
                stack.forEach((diskSize, diskIdx) => {
                    const diskWidth = MIN_DISK_WIDTH + (diskSize - 1) * DISK_WIDTH_STEP;
                    const diskLeft = peg_x_center - diskWidth / 2;
                    const diskTop = PEG_Y_BOTTOM - BASE_HEIGHT - (diskIdx * DISK_HEIGHT) - DISK_HEIGHT;
                    
                    // ★★★ 色が足りない場合(10枚以上)でもエラーにならないようにする ★★★
                    const colorIndex = (diskSize - 1) % DISK_COLORS.length;
                    const color = DISK_COLORS[colorIndex];
                    
                    this.ctx.fillStyle = color;
                    this.ctx.fillRect(diskLeft, diskTop, diskWidth, DISK_HEIGHT);
                    
                    this.ctx.strokeStyle = COLOR_DISK_OUTLINE;
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeRect(diskLeft, diskTop, diskWidth, DISK_HEIGHT);
                });
            });

            // --- クリアメッセージの描画 ---
            if (this.isWin) {
                const boxWidth = 450;
                const boxHeight = 200;
                const boxLeft = (SCREEN_WIDTH / 2) - boxWidth / 2;
                const boxTop = (SCREEN_HEIGHT / 2) - boxHeight / 2;
                
                this.ctx.fillStyle = COLOR_WIN_BG;
                this.ctx.fillRect(boxLeft, boxTop, boxWidth, boxHeight);
                
                this.drawText("CLEAR!", SCREEN_WIDTH / 2, SCREEN_HEIGHT / 2 - 30, this.fontLarge, COLOR_TEXT);
                
                const timeStr = `${this.totalTime.toFixed(2)} 秒`;
                this.drawText(`タイム: ${timeStr}`, SCREEN_WIDTH / 2, SCREEN_HEIGHT / 2 + 30, this.fontMedium, COLOR_TEXT);

                const resultText = `移動回数: ${this.moveCount} (最短: ${this.optimalMoves})`;
                this.drawText(resultText, SCREEN_WIDTH / 2, SCREEN_HEIGHT / 2 + 70, this.fontMedium, COLOR_TEXT);
            }
        }
    }

    // ★★★ ゲームの開始 (デフォルトは3枚) ★★★
    const game = new HanoiGame('gameCanvas', 3);

    // ★★★ UIのイベントリスナーをゲームインスタンスに接続 ★★★
    document.getElementById('btn3').addEventListener('click', () => {
        game.changeDisks(3);
    });
    document.getElementById('btn5').addEventListener('click', () => {
        game.changeDisks(5);
    });
    document.getElementById('btn10').addEventListener('click', () => {
        game.changeDisks(10);
    });

</script>

</body>
</html>
